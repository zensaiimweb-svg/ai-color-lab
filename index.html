<style>
    /* 기존 스타일 유지하면서 아래 항목 추가/수정 */
    #result { margin-top: 30px; padding: 20px; border-radius: 15px; display: none; } /* 처음엔 숨김 */
    .color-circle { width: 80px; h-eight: 80px; border-radius: 50%; margin: 0 auto 20px; border: 2px solid #444; }
    .recommend-btn { 
        display: block; width: 100%; padding: 15px; margin-top: 15px; 
        background: #FF3548; color: #fff; text-decoration: none; 
        border-radius: 8px; font-weight: bold; font-size: 0.9rem;
    }
    .status-text { color: #888; font-size: 0.8rem; margin-top: 10px; }
</style>

<div id="result">
    <div id="skin-preview" class="color-circle"></div>
    <div id="analysis-text"></div>
    <a id="shop-link" href="#" class="recommend-btn" target="_blank">내 톤에 맞는 베스트 상품 구매하기</a>
    <p class="status-text">※ 3nh PS110 정밀 계측 데이터 기반 분석</p>
</div>

<script>
    // 1. Lab을 RGB로 변환하는 핵심 함수
    function labToRgb(l, a, b) {
        let y = (l + 16) / 116;
        let x = a / 500 + y;
        let z = y - b / 200;
        const f = (t) => (t > 0.206893 ? Math.pow(t, 3) : (t - 16 / 116) / 7.787);
        x = 0.95047 * f(x); y = 1.00000 * f(y); z = 1.08883 * f(z);
        let r = x * 3.2406 + y * -1.5372 + z * -0.4986;
        let g = x * -0.9689 + y * 1.8758 + z * 0.0415;
        let bl = x * 0.0557 + y * -0.2040 + z * 1.057;
        const clip = (c) => {
            c = c > 0.0031308 ? 1.055 * Math.pow(c, 1 / 2.4) - 0.055 : 12.92 * c;
            return Math.max(0, Math.min(255, Math.round(c * 255)));
        };
        return `rgb(${clip(r)}, ${clip(g)}, ${clip(bl)})`;
    }

    function diagnose() {
        const L = parseFloat(document.getElementById('L_val').value);
        const a = parseFloat(document.getElementById('a_val').value);
        const b = parseFloat(document.getElementById('b_val').value);
        const resDiv = document.getElementById('result');
        const textDiv = document.getElementById('analysis-text');
        const previewDiv = document.getElementById('skin-preview');
        const shopLink = document.getElementById('shop-link');

        if(isNaN(L) || isNaN(a) || isNaN(b)) {
            alert("수치를 정확히 입력해주세요.");
            return;
        }

        // 2. 정밀 진단 알고리즘 (한국인 피부톤 데이터 기준)
        let tone = "";
        let season = "";
        let shopQuery = "";
        
        // 밝기 판단
        const brightness = L > 66 ? "밝은(Light)" : (L > 60 ? "중간(Medium)" : "차분한(Deep)");
        
        // 웜/쿨 판단 (한국인 평균 b값 17~18 기준)
        const isWarm = b > 17.8; 

        if (isWarm) {
            season = L > 65 ? "봄 웜톤 (Spring Warm)" : "가을 웜톤 (Autumn Warm)";
            shopQuery = isWarm ? "웜톤 파운데이션" : "봄웜 립스틱";
        } else {
            season = L > 65 ? "여름 쿨톤 (Summer Cool)" : "겨울 쿨톤 (Winter Cool)";
            shopQuery = "쿨톤 립스틱";
        }

        // 3. 시각화 및 결과 노출
        const skinColor = labToRgb(L, a, b);
        previewDiv.style.backgroundColor = skinColor;
        
        resDiv.style.display = "block"; // 결과창 표시
        textDiv.innerHTML = `
            <span style="color:#888; font-size:0.9rem;">당신의 피부 톤은</span><br>
            <strong style="font-size:1.5rem; color:#fff;">${brightness} ${season}</strong><br>
            <p style="font-size:0.85rem; color:#aaa; margin-top:10px;">
                L*(밝기): ${L} | a*(붉은기): ${a} | b*(노란기): ${b}
            </p>
        `;

        // 4. 수수료 모델 링크 생성 (올리브영 검색 결과 예시)
        // 여기에 본인의 파트너스 링크(딥링크)를 넣으시면 됩니다.
        shopLink.href = `https://www.oliveyoung.co.kr/store/search/getSearchMain.do?query=${encodeURIComponent(season + " 추천")}`;
        
        // 분석 버튼 클릭 시 부드럽게 아래로 스크롤
        window.scrollTo({ top: resDiv.offsetTop, behavior: 'smooth' });
    }
</script>
